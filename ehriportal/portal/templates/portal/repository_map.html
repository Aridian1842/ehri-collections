{% extends 'site_base.html' %}

{% load highlight %}
{% load i18n %}
{% load ifsetting_tag %}
{% load pagination_tags %}
{% block head_title %}{% trans "Repositories" %}{% endblock %}

{% block body_class %}repositories{% endblock %}


{% block body %}
    <form id="search-form">
        <input type="text" name="q" id="id_q" value="{{form.q.value|default_if_none:""}}" class="span5" />
        <input type="submit" value="Search">
    </form>
    <h3>
        {% if paginator.count %}
        {% with paginator.count|pluralize as pluralcount %}
        {{paginator.count}} {% trans "Result"|add:pluralcount %}
        {% endwith %}
        {% if form.q.value %}
        &nbsp;for <i>{{form.q.value}}</i>
        {% endif %}
    {% else %}
        {% if form.q.value %}
        {% trans "Nothing found for" %} <i>{{form.q.value}}</i>{% if suggestion %}.&nbsp;{% trans "Did you mean" %} <a               
                href="{{request.path}}?q={{suggestion|urlencode}}"><i>{{suggestion}}</i></a>?{% endif %}
        {% endif %}
    {% endif %}
    </h3>
    <div id="map_canvas" style="width:100%;height:600px;">

    </div>

<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC7RVUST3aa1HyStY8UPQp71bxFoYWvtfM&sensor=false">
</script>
<script type="text/javascript">
    function initialize() {
        var myOptions = {
            center: new google.maps.LatLng(56, 24),
            zoom: 4,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        return new google.maps.Map(document.getElementById("map_canvas"),
            myOptions);
    }

    function getParameterByName(url, name) {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(url);
        if(results == null)
            return "";
        else
            return decodeURIComponent(results[1].replace(/\+/g, " "));
    }
    var gmap, gmarkers = [];
    $(function() {
        gmap = initialize();

        window.onpopstate = function(event) {
            $("#id_q").val(getParameterByName(window.location.search, "q"));
            $("#search-form").submit();
        };

        $("#search-form").submit(function(event) {
            var val = $("#id_q").val();
            console.log("Submit!", val);
            // fix the browser URL
            window.history.pushState({q:val}, window.title, 
                window.location.pathname + "?" + $(this).serialize());
            // fetch the data
            $.ajax({
                url: window.location.href,
                data: {format: "json"},
                dataType: "json",
                error: function() {
                    console.error(arguments);
                },
                success: function(data) {
                    console.log("" + data.object_list.length + " Results");
                    $.each(gmarkers, function(i, m) { m.setMap(null);});
                    $.each(data.object_list, function(i, repo) {
                        if (repo.location) {
                            console.log("Adding repo", repo.name, repo.location);
                            gmarkers.push(new google.maps.Marker({
                                position: new google.maps.LatLng(repo.location[1],
                                              repo.location[0]),
                                map: gmap,
                                title: repo.name,
                            }));    
                        } else {
                            console.log("NO LOCATION for ", repo.name);
                        }
                    });
                },
            });

            event.preventDefault();        
        });
    });
</script>

{% endblock %}
